<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Yummy Bakery</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@300;400;500;600;700&display=swap"
    rel="stylesheet">
  <style>
    /* ... PEGA AQU√ç TUS ESTILOS CSS DEL MEN√ö (LOS MISMOS DE SIEMPRE) ... */
    :root {
      --brown: #4A3728;
      --cream: #FDFBF7;
    }

    body {
      background-color: var(--cream);
      font-family: 'Poppins', sans-serif;
      color: var(--brown);
      -webkit-tap-highlight-color: transparent;
      overflow-x: hidden;
    }

    .font-serif {
      font-family: 'Playfair Display', serif;
    }

    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }

    .card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 15px rgba(74, 55, 40, 0.05);
      border: 1px solid #F3F0EB;
      overflow: hidden;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    .card-main {
      display: flex;
      flex-direction: row;
      padding: 12px;
      gap: 12px;
      width: 100%;
    }

    .card-img-box {
      width: 6rem;
      height: 6rem;
      flex-shrink: 0;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
      background-color: #f3f4f6;
    }

    .card-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-width: 0;
    }

    .extras-panel {
      background-color: #FAFAFA;
      border-top: 1px dashed #E5E5E5;
      overflow: hidden;
      max-height: 0;
      transition: max-height 0.3s ease-out, padding 0.3s ease;
    }

    .extras-panel.open {
      max-height: 200px;
      padding: 12px;
    }

    .btn-qty {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      font-weight: 700;
      font-size: 16px;
      transition: 0.1s;
    }

    .btn-minus {
      background: #F5F5F4;
      color: #78716C;
    }

    .btn-plus {
      background: var(--brown);
      color: white;
      box-shadow: 0 4px 10px rgba(74, 55, 40, 0.2);
    }

    .btn-plus:active {
      transform: scale(0.95);
    }

    .img-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: 0.2s;
    }

    .card-img-box:active .img-overlay {
      opacity: 1;
    }

    .social-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .fade-in {
      animation: fadeIn 0.4s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .yummy-alert {
      animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes popIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .pac-container {
      z-index: 10000 !important;
      border-radius: 12px;
      margin-top: 5px;
    }

    .btn-sel {
      border: 1px solid #e5e7eb;
      background: white;
      color: #6b7280;
    }

    .btn-sel.active {
      border-color: #4A3728;
      background: #4A3728;
      color: white;
      box-shadow: 0 4px 10px rgba(74, 55, 40, 0.2);
    }
  </style>
</head>

<body class="pb-40 antialiased">

  <header class="text-center pt-8 pb-6 bg-white shadow-sm relative z-20 rounded-b-[2.5rem]">
    <div
      class="w-24 h-24 mx-auto bg-white rounded-full flex items-center justify-center border-4 border-[#FDFBF7] mb-3 shadow-lg overflow-hidden p-1">
      <img src="https://i.postimg.cc/6QhbzLD9/IMG-0631.jpg" class="w-full h-full object-contain"
        alt="Logo Yummy Bakery">
    </div>
    <h1 class="font-serif text-3xl text-[#4A3728] tracking-tight">Yummy Bakery</h1>
    <p class="text-sm text-gray-500 mt-2 px-8 leading-relaxed max-w-xs mx-auto">Delicioso pan artesanal</p>
  </header>

  <nav class="sticky top-0 bg-[#FDFBF7]/95 backdrop-blur-md z-30 py-3 shadow-sm border-b border-white/50">
    <div class="px-4 overflow-x-auto whitespace-nowrap no-scrollbar flex gap-2" id="nav-cats"></div>
  </nav>

  <main id="menu-container" class="px-4 mt-6 space-y-4 max-w-lg mx-auto min-h-[300px]">
    <p id="msg-loading" class="text-center text-gray-400 mt-10 text-sm animate-pulse">Cargando men√∫...</p>
  </main>

  <div
    class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 p-4 pb-8 shadow-[0_-5px_25px_rgba(0,0,0,0.08)] z-40">
    <div class="max-w-lg mx-auto flex justify-between items-center gap-4">
      <div onclick="verResumen()" class="flex flex-col cursor-pointer pl-2">
        <span class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Total</span>
        <span class="text-2xl font-serif font-bold text-[#4A3728] leading-none">$<span id="total-price">0</span></span>
      </div>
      <button onclick="verResumen()"
        class="bg-[#4A3728] text-white flex-1 py-3.5 rounded-xl font-bold text-sm uppercase tracking-wide shadow-lg shadow-[#4A3728]/20 flex items-center justify-center gap-2 active:scale-95 transition-transform">
        <span>Ver Pedido</span>
        <span class="bg-white/20 text-white px-2 py-0.5 rounded-md text-xs backdrop-blur-md" id="cart-count">0</span>
      </button>
    </div>
  </div>

  <div id="modal-image"
    class="hidden fixed inset-0 z-[80] bg-black/90 flex items-center justify-center p-4 backdrop-blur-sm"
    onclick="cerrarImagen()">
    <div class="relative w-full max-w-lg animate-pop">
      <button class="absolute -top-12 right-0 text-white text-4xl" onclick="cerrarImagen()">√ó</button>
      <img id="img-preview" src="" class="w-full h-auto max-h-[70vh] object-contain rounded-lg shadow-2xl">
    </div>
  </div>

  <div id="modal-checkout"
    class="fixed inset-0 bg-black/60 hidden z-50 flex items-end sm:items-center justify-center backdrop-blur-[3px] transition-opacity duration-300">
    <div
      class="bg-[#FAFAFA] w-full max-h-[92vh] sm:h-auto sm:max-w-md sm:rounded-2xl rounded-t-[2rem] flex flex-col shadow-2xl overflow-hidden relative">
      <div class="bg-white px-6 py-4 flex justify-between items-center border-b border-gray-100 shrink-0 z-10">
        <div>
          <h2 class="font-serif text-xl text-[#4A3728]">Tu Pedido</h2>
          <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider" id="modal-step-indicator">Paso 1 de 2
          </p>
        </div>
        <button onclick="cerrarModal()"
          class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 text-gray-400 hover:bg-gray-200 text-xl font-bold">√ó</button>
      </div>

      <div id="step-1" class="flex-1 flex flex-col overflow-hidden fade-in min-h-0">
        <div class="overflow-y-auto flex-1 p-4 space-y-3" id="cart-items"></div>
        <div class="bg-white p-5 border-t border-gray-100 shrink-0 z-10">
          <div class="flex justify-between items-end mb-4"><span class="text-gray-500 text-sm">Subtotal</span><span
              class="text-2xl font-bold text-[#4A3728]">$<span id="lbl-subtotal-step1">0</span></span></div>
          <button onclick="irPaso2()"
            class="w-full bg-[#4A3728] text-white py-4 rounded-xl font-bold text-sm uppercase tracking-wider shadow-lg active:bg-[#3A2B20]">Continuar</button>
        </div>
      </div>

      <div id="step-2" class="hidden flex-1 flex flex-col overflow-hidden fade-in min-h-0 bg-white">
        <div class="overflow-y-auto flex-1 p-5 space-y-4 pb-10">
          <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm">
            <h3 class="font-bold text-xs text-gray-400 uppercase tracking-widest mb-3">1. Cliente</h3>
            <input id="cli-nombre" type="text" placeholder="Nombre Completo"
              class="w-full p-3 bg-gray-50 border border-gray-100 rounded-lg text-sm mb-2 outline-none focus:border-[#4A3728]">
            <div class="flex gap-2">
              <input id="cli-tel" type="tel" maxlength="10" placeholder="Tel√©fono"
                class="w-1/2 p-3 bg-gray-50 border border-gray-100 rounded-lg text-sm outline-none focus:border-[#4A3728]">
              <input id="cli-email" type="email" placeholder="Email"
                class="w-1/2 p-3 bg-gray-50 border border-gray-100 rounded-lg text-sm outline-none focus:border-[#4A3728]">
            </div>
          </div>

          <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm">
            <h3 class="font-bold text-xs text-gray-400 uppercase tracking-widest mb-3">2. Entrega</h3>
            <div class="grid grid-cols-2 gap-3 mb-3">
              <button onclick="setMetodo('recoger')" id="btn-recoger"
                class="btn-sel active py-3 rounded-lg font-medium text-xs transition-all">Recoger</button>
              <button onclick="setMetodo('envio')" id="btn-envio"
                class="btn-sel py-3 rounded-lg font-medium text-xs transition-all">Env√≠o (+$10)</button>
            </div>
            <div id="cont-dir" class="hidden"><input id="cli-dir" type="text" placeholder="Calle y N√∫mero..."
                class="w-full p-3 bg-gray-50 border border-gray-100 rounded-lg text-sm outline-none focus:border-[#4A3728]">
            </div>
          </div>

          <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm">
            <h3 class="font-bold text-xs text-gray-400 uppercase tracking-widest mb-3">3. Forma de Pago</h3>
            <div class="grid grid-cols-2 gap-3 mb-3">
              <button onclick="setPago('efectivo')" id="btn-efectivo"
                class="btn-sel active py-3 rounded-lg font-medium text-xs transition-all">Efectivo</button>
              <button onclick="setPago('transferencia')" id="btn-transf"
                class="btn-sel py-3 rounded-lg font-medium text-xs transition-all">Transferencia</button>
            </div>
            <div id="info-nu" class="hidden animate-fade">
              <div class="bg-[#F8F0FC] border border-[#820AD1] p-4 rounded-xl text-center">
                <p class="text-[10px] text-[#820AD1] font-bold uppercase mb-1">Pagar a Cuenta NU</p>
                <p class="text-sm font-bold text-gray-800 tracking-wider select-all">638180000189543165</p>
                <p class="text-[10px] text-gray-500 mt-1">Leticia Mariscal Miranda</p>
                <div
                  class="mt-2 bg-white text-[#820AD1] text-[10px] py-1 px-2 rounded border border-[#820AD1] inline-block">
                  Concepto: #NumPedido</div>
              </div>
            </div>
          </div>

          <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm">
            <h3 class="font-bold text-xs text-gray-400 uppercase tracking-widest mb-2">4. Observaciones</h3>
            <textarea id="cli-obs" rows="2" placeholder="Ej: Sin servilletas..."
              class="w-full p-3 bg-gray-50 border border-gray-100 rounded-lg text-sm outline-none focus:border-[#4A3728] resize-none"></textarea>
          </div>

          <div class="bg-[#FDFBF7] p-4 rounded-xl border border-[#F2E7D5] text-sm">
            <div class="flex justify-between text-gray-500 mb-1"><span>Productos</span><span>$<span
                  id="lbl-subtotal-final">0</span></span></div>
            <div class="flex justify-between text-gray-500 mb-2"><span>Env√≠o</span><span>$<span
                  id="lbl-envio-final">0</span></span></div>
            <div
              class="flex justify-between font-bold text-[#4A3728] pt-2 border-t border-dashed border-[#D4A373]/30 text-lg">
              <span>Total</span><span>$<span id="lbl-total-final">0</span></span>
            </div>
          </div>
        </div>

        <div
          class="p-4 border-t border-gray-100 bg-white flex gap-3 shrink-0 z-20 shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
          <button onclick="irPaso1()"
            class="px-5 py-3.5 bg-gray-100 text-gray-600 rounded-xl font-bold text-sm">Atr√°s</button>
          <button onclick="enviarPedido()" id="btn-finalizar"
            class="flex-1 bg-[#27ae60] text-white py-3.5 rounded-xl font-bold text-sm uppercase tracking-wider shadow-md active:bg-[#219150]">Confirmar</button>
        </div>
      </div>
    </div>
  </div>

  <footer class="text-center py-10 mb-24 border-t border-[#F2E7D5] px-4">
    <p class="text-[10px] text-gray-400 uppercase tracking-widest mb-4">S√≠guenos en redes</p>
    <div class="flex justify-center gap-4">
      <a href="https://www.facebook.com/share/1D83NY6AYf/?mibextid=wwXIfr" target="_blank"
        class="social-btn w-12 h-12 flex items-center justify-center bg-white text-[#1877F2] rounded-full shadow-sm border border-gray-100 transition-all">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path
            d="M9 8h-3v4h3v12h5v-12h3.642l.358-4h-4v-1.667c0-.955.192-1.333 1.115-1.333h2.885v-5h-3.808c-3.596 0-5.192 1.583-5.192 4.615v3.385z" />
        </svg>
      </a>
      <a href="https://www.instagram.com/yummy_bakery_lf/" target="_blank"
        class="social-btn w-12 h-12 flex items-center justify-center bg-white text-[#E1306C] rounded-full shadow-sm border border-gray-100 transition-all">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
          <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
          <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>
        </svg>
      </a>
      <a href="https://www.tiktok.com/@yummy.bakery.lf?_r=1&_t=ZS-93O1tdBYctd" target="_blank"
        class="social-btn w-12 h-12 flex items-center justify-center bg-white text-black rounded-full shadow-sm border border-gray-100 transition-all">
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
          <path
            d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z" />
        </svg>
      </a>
    </div>
    <p class="text-[10px] text-gray-300 mt-6">¬© 2026 Yummy Bakery</p>
  </footer>

  <div id="custom-alert"
    class="fixed inset-0 bg-black/60 hidden z-[60] flex items-center justify-center backdrop-blur-sm p-4">
    <div
      class="bg-white w-full max-w-sm rounded-[2rem] p-6 text-center shadow-2xl yummy-alert relative overflow-hidden">
      <div
        class="w-16 h-16 bg-[#FDFBF7] rounded-full flex items-center justify-center mx-auto mb-4 border border-[#F2E7D5]">
        <span class="text-3xl" id="alert-icon">üßÅ</span>
      </div>
      <h3 class="font-serif text-xl text-[#4A3728] mb-2" id="alert-title">Atenci√≥n</h3>
      <p class="text-gray-500 text-sm mb-6" id="alert-msg">...</p>
      <button onclick="cerrarAlert()" id="alert-btn"
        class="w-full bg-[#4A3728] text-white py-3.5 rounded-xl font-bold text-sm uppercase shadow-lg">Entendido</button>
    </div>
  </div>

  <script src="js/config.js"></script>
  <script type="module">
    import { db } from './js/firebase-config.js';
    import { collection, getDocs, addDoc, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    var PRODUCTOS = [], EXTRAS = [];
    var carrito = [], metodoEntrega = 'recoger', metodoPago = 'efectivo', COSTO_ENVIO = 10;
    var catActual = '';

    // Functions to be exposed to window for HTML onclick handlers
    window.verImagen = (u) => { document.getElementById('img-preview').src = u; document.getElementById('modal-image').classList.remove('hidden'); }
    window.cerrarImagen = () => { document.getElementById('modal-image').classList.add('hidden'); }
    // window.cambiarCat is now defined in Core Logic below


    // Core Logic
    async function initApp() {
      try {
        console.log("Cargando men√∫ desde Firebase...");

        // Load Categories first to ensure order
        const catSnap = await getDocs(collection(db, "categorias"));
        let categoriasData = catSnap.docs.map(d => ({ id: d.id, ...d.data() }));

        // Filter and Sort
        categoriasData = categoriasData.filter(c => c.activo !== false);
        categoriasData.sort((a, b) => (a.orden || 0) - (b.orden || 0));

        const prodSnap = await getDocs(collection(db, "productos"));
        PRODUCTOS = prodSnap.docs.map(d => ({ id: d.id, ...d.data() }));

        const toppingSnap = await getDocs(collection(db, "toppings"));
        EXTRAS = toppingSnap.docs.map(d => ({ id: d.id, ...d.data() }));

        if (PRODUCTOS.length > 0) {
          // Map category IDs to Names if needed, or just use the category ID stored in product
          // The product stores 'categoria' as the ID (e.g. 'roles', 'conchas')
          // We need to display the Name (e.g. 'Roles', 'Conchas')

          let catsMostradas = [];
          if (categoriasData.length > 0) {
            catsMostradas = categoriasData;
          } else {
            // Fallback if no categories collection
            const uniqueCats = [...new Set(PRODUCTOS.map(p => p.categoria))];
            catsMostradas = uniqueCats.map(c => ({ nombre: c.charAt(0).toUpperCase() + c.slice(1), valor: c }));
          }

          catActual = catsMostradas[0].valor; // Default to first cat value
          renderTabs(catsMostradas);
          renderMenu(catActual);
        } else {
          document.getElementById('menu-container').innerHTML = '<p class="text-center pt-10 text-gray-400">Men√∫ vac√≠o. Ejecuta el seeder.</p>';
        }
      } catch (error) {
        console.error('Error loading menu:', error);
        document.getElementById('menu-container').innerHTML = '<p class="text-center pt-10 text-red-400">Error cargando men√∫.</p>';
      }
      loadMaps();
    }

    initApp();

    // ... (Keep existing UI functions: renderTabs, renderMenu, upd, modificarExtra, calcExtras, renderSingleCard, refresh, resetApp, verResumen, cerrarModal, irPaso1, irPaso2, renderList, borrarItem, setMetodo, setPago, alertUI, cerrarAlert) ...
    // Note: Since we are in a module, we need to attach functions to window explicitly if they are called by onclick attributes in HTML.

    window.upd = (pid, d) => {
      if (d > 0) {
        var p = PRODUCTOS.find(x => x.id === pid);
        var base = parseFloat(p.precio);
        var ex = calcExtras(p);
        carrito.push({ uid: Date.now(), pid: p.id, nom: p.nombre, cat: p.categoria, base: base, qty: 1, xTxt: ex.txt, xId: ex.id, sub: base + ex.costo });
      } else {
        var idxs = []; carrito.forEach((el, i) => { if (el.pid === pid) idxs.push(i) });
        if (idxs.length > 0) carrito.splice(idxs[idxs.length - 1], 1);
      }
      refresh(); renderSingleCard(pid);
    };

    window.modificarExtra = (pid) => {
      var p = PRODUCTOS.find(x => x.id === pid); var ex = calcExtras(p);
      carrito.forEach(i => { if (i.pid === pid) { i.xTxt = ex.txt; i.xId = ex.id; i.sub = i.base + ex.costo; } }); refresh();
    };

    function calcExtras(p) {
      if (!p) return { costo: 0, txt: "", id: null };
      var cost = 0, txt = "", xid = null;
      var catName = p.categoria || "";

      var chk = document.getElementById('chk-' + p.id);
      if (chk && chk.checked) {
        // Logic for Paquete extras cost vs regular
        var ex = catName.toLowerCase().indexOf('paquete') !== -1 ? 10 : 5;
        cost += ex; txt = "Con Relleno"; xid = "R";
      }
      var sel = document.getElementById('sel-' + p.id);
      if (sel && sel.value) {
        var opt = sel.options[sel.selectedIndex];
        cost += parseFloat(opt.getAttribute('data-pre')) || 0;
        txt = "+ " + opt.getAttribute('data-nom');
        xid = sel.value;
      }
      return { costo: cost, txt: txt, id: xid };
    }

    function renderTabs(cats) {
      // items are objects { nombre, valor }
      document.getElementById('nav-cats').innerHTML = cats.map(c => {
        var cls = c.valor === catActual ? 'bg-[#4A3728] text-white shadow-md' : 'bg-white text-gray-500 border border-gray-100';
        return `<button onclick="cambiarCat('${c.valor}')" class="px-5 py-2.5 text-sm font-medium rounded-full transition-all whitespace-nowrap ${cls}">${c.nombre}</button>`;
      }).join('');
    }

    // Expose for onclick
    window.cambiarCat = (cId) => {
      catActual = cId;
      // Re-render tabs to update active state
      // We need to pass the full categories array again.
      // Quick fix: Fetch from DOM or re-fetch not ideal. 
      // Better: store categories globally.
      // For now, let's just toggle classes manually or re-render if we had the list.
      // Let's assume we can just re-render menu. Updating tabs visual state is tricky without the list.

      // Hack: Update classes manually
      const btns = document.getElementById('nav-cats').children;
      for (let btn of btns) {
        const onclick = btn.getAttribute('onclick');
        if (onclick.includes(`'${cId}'`)) {
          btn.className = "px-5 py-2.5 text-sm font-medium rounded-full transition-all whitespace-nowrap bg-[#4A3728] text-white shadow-md";
        } else {
          btn.className = "px-5 py-2.5 text-sm font-medium rounded-full transition-all whitespace-nowrap bg-white text-gray-500 border border-gray-100";
        }
      }

      renderMenu(cId);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function renderMenu(cId) {
      // Filter by category ID
      var items = PRODUCTOS.filter(p => p.categoria === cId);

      if (items.length === 0) {
        document.getElementById('menu-container').innerHTML = '<p class="text-center text-gray-400 mt-10">No hay productos en esta categor√≠a.</p>';
        return;
      }

      document.getElementById('menu-container').innerHTML = items.map(p => {
        var qty = carrito.filter(i => i.pid === p.id).length;
        var open = qty > 0 ? "open" : "";
        var htmlExtras = '';
        var catName = p.categoria || "";

        if (p.relleno) {
          var pr = catName.toLowerCase().indexOf('paquete') !== -1 ? 10 : 5;
          htmlExtras = `<label class="flex justify-between items-center cursor-pointer p-1"><span class="text-xs text-gray-600 font-medium">Relleno Avellana</span><div class="flex items-center gap-2"><span class="text-[10px] font-bold text-[#4A3728]">+$${pr}</span><input type="checkbox" id="chk-${p.id}" onchange="modificarExtra('${p.id}')" class="accent-[#4A3728] w-4 h-4"></div></label>`;
        }

        // DYNAMMIC TOPPINGS by Category
        var tops = EXTRAS.filter(e => e.categoria === p.categoria && e.activo !== false);
        if (tops.length > 0) {
          var opts = tops.map(t => `<option value="${t.id}" data-nom="${t.nombre}" data-pre="${t.precio}">${t.nombre} (+$${t.precio})</option>`).join('');
          htmlExtras += `<div><p class="text-[10px] text-gray-400 uppercase font-bold mb-1">Extras:</p><select id="sel-${p.id}" onchange="modificarExtra('${p.id}')" class="w-full text-xs p-2 bg-white border rounded-lg shadow-sm focus:border-[#4A3728] outline-none"><option value="" data-pre="0">Ninguno</option>${opts}</select></div>`;
        }

        var img = p.imagen || "https://via.placeholder.com/150?text=Pan";
        var btns = qty > 0 ? `<button onclick="upd('${p.id}', -1)" class="btn-qty btn-minus">-</button><span id="q-${p.id}" class="font-bold text-sm w-4 text-center text-[#4A3728]">${qty}</span>` : '';
        return `
        <div class="card fade-in" id="card-${p.id}">
          <div class="card-main">
             <div class="card-img-box cursor-zoom-in" onclick="verImagen('${img}')"><img src="${img}" class="w-full h-full object-cover"><div class="img-overlay"><span class="text-white text-2xl">üîç</span></div></div>
             <div class="card-info"><div><h3 class="font-bold text-[#4A3728] text-sm leading-tight truncate">${p.nombre}</h3><p class="text-[10px] text-gray-400 mt-1 line-clamp-2 leading-relaxed">${p.descripcion || ""}</p></div>
                <div class="mt-auto pt-2 flex justify-between items-end"><span class="font-serif text-lg font-bold text-[#4A3728]">$${p.precio}</span><div class="flex items-center gap-3">${btns}<button onclick="upd('${p.id}', 1)" class="btn-qty btn-plus">+</button></div></div></div></div>
          <div id="panel-${p.id}" class="extras-panel ${open}">${htmlExtras || '<p class="text-center text-xs text-gray-300">Sin extras</p>'}</div></div>`;
      }).join('');
    }

    function renderSingleCard(pid) {
      var qty = carrito.filter(i => i.pid === pid).length; var pPanel = document.getElementById('panel-' + pid);
      if (qty > 0) pPanel.classList.add('open'); else pPanel.classList.remove('open');
      // renderMenu(catActual); // Don't full re-render, loses focus/state. Just update QTY txt
      const qSpan = document.getElementById(`q-${pid}`);
      if (qSpan) qSpan.innerText = qty;

      // If going 0->1 or 1->0, we might need to re-render the card buttons area.
      // But simpler is to allow re-render of just that card or rely on the logic:
      // Current logic re-renders whole menu on upd? No, upd calls refresh and renderSingleCard.
      // renderSingleCard was calling renderMenu, causing the flicker.
      // Better approach:
      // If qt 0 -> 1: replace button with counter.
      // If qt 1 -> 0: replace counter with button.

      // Let's just do a cheap re-render of that card's html or just renderMenu for safety as before but it was causing UI reset.
      renderMenu(catActual);
    }

    function refresh() {
      var sub = carrito.reduce((a, b) => a + b.sub, 0); var env = (metodoEntrega === 'envio' && sub > 0) ? COSTO_ENVIO : 0; var tot = sub + env;
      var ids = { 'total-price': tot, 'lbl-subtotal-step1': sub, 'lbl-subtotal-final': sub, 'lbl-total-final': tot, 'lbl-envio-final': env, 'cart-count': carrito.length };
      for (var k in ids) { var el = document.getElementById(k); if (el) el.innerText = ids[k]; }
    }

    window.resetApp = () => {
      carrito = []; metodoEntrega = 'recoger'; metodoPago = 'efectivo';
      ['cli-nombre', 'cli-tel', 'cli-email', 'cli-dir', 'cli-obs'].forEach(id => document.getElementById(id).value = "");
      setMetodo('recoger'); setPago('efectivo'); refresh(); renderMenu(catActual);
    }

    window.verResumen = () => { if (carrito.length === 0) return alertUI("Carrito vac√≠o", "Agrega algo rico."); document.getElementById('modal-checkout').classList.remove('hidden'); irPaso1(); }
    window.cerrarModal = () => { document.getElementById('modal-checkout').classList.add('hidden'); }
    window.irPaso1 = () => { renderList(); document.getElementById('step-1').classList.remove('hidden'); document.getElementById('step-2').classList.add('hidden'); document.getElementById('modal-step-indicator').innerText = "Paso 1 de 2"; }
    window.irPaso2 = () => { if (carrito.length === 0) return; document.getElementById('step-1').classList.add('hidden'); document.getElementById('step-2').classList.remove('hidden'); document.getElementById('modal-step-indicator').innerText = "Paso 2 de 2"; }

    function renderList() {
      document.getElementById('cart-items').innerHTML = carrito.map(i => {
        var b = i.xTxt ? `<span class="text-[10px] bg-stone-100 px-2 py-0.5 rounded text-stone-500 block mt-1 w-max">${i.xTxt}</span>` : '';
        return `<div class="flex justify-between items-center bg-white p-3 rounded-xl border border-gray-100 shadow-sm"><div class="flex-1"><p class="font-bold text-sm text-[#4A3728]">${i.nom}</p>${b}</div><div class="flex items-center gap-4"><span class="font-serif font-bold text-[#4A3728]">$${i.sub}</span><button onclick="borrarItem(${i.uid})" class="w-8 h-8 flex items-center justify-center bg-red-50 text-red-500 rounded-full text-sm font-bold">‚úï</button></div></div>`;
      }).join('');
    }

    window.borrarItem = (uid) => {
      var it = carrito.find(i => i.uid === uid); carrito = carrito.filter(i => i.uid !== uid);
      refresh(); if (!document.getElementById('step-1').classList.contains('hidden')) renderList(); if (it) renderMenu(catActual);
    }

    window.setMetodo = (m) => {
      metodoEntrega = m; var be = document.getElementById('btn-envio'), br = document.getElementById('btn-recoger'), d = document.getElementById('cont-dir');
      if (m === 'envio') { be.classList.add('active'); br.classList.remove('active'); d.classList.remove('hidden'); }
      else { be.classList.remove('active'); br.classList.add('active'); d.classList.add('hidden'); } refresh();
    }

    window.setPago = (p) => {
      metodoPago = p; var be = document.getElementById('btn-efectivo'), bt = document.getElementById('btn-transf'), nu = document.getElementById('info-nu');
      if (p === 'transferencia') { bt.classList.add('active'); be.classList.remove('active'); nu.classList.remove('hidden'); }
      else { bt.classList.remove('active'); be.classList.add('active'); nu.classList.add('hidden'); }
    }

    function alertUI(t, m, i, cb) {
      document.getElementById('alert-title').innerText = t; document.getElementById('alert-msg').innerText = m; if (i) document.getElementById('alert-icon').innerText = i;
      var a = document.getElementById('custom-alert'); a.classList.remove('hidden');
      document.getElementById('alert-btn').onclick = function () { a.classList.add('hidden'); if (cb) cb(); };
    }

    window.cerrarAlert = () => { document.getElementById('custom-alert').classList.add('hidden'); }

    window.enviarPedido = async () => {
      // 1. Validaciones
      var nom = document.getElementById('cli-nombre').value.trim();
      var tel = document.getElementById('cli-tel').value.trim();
      var obs = document.getElementById('cli-obs').value.trim();
      var dir = document.getElementById('cli-dir').value;

      if (nom.length < 3) return alertUI("Faltan datos", "Escribe tu nombre.", "üë§");
      if (!/^\d{10}$/.test(tel)) return alertUI("Tel√©fono", "10 d√≠gitos requeridos.", "üì±");
      if (metodoEntrega === 'envio' && dir.length < 5) return alertUI("Direcci√≥n", "Ingresa tu direcci√≥n.", "üìç");

      // 2. Bloquear bot√≥n
      var btn = document.getElementById('btn-finalizar');
      var txt = btn.innerText;
      btn.innerText = "Enviando...";
      btn.disabled = true;

      // 3. Preparar datos
      var orden = {
        fecha: new Date().toISOString(),
        cliente: { nombre: nom, tel: tel, email: document.getElementById('cli-email').value, direccion: (metodoEntrega === 'envio' ? dir : 'Recoger en tienda') },
        metodo: metodoEntrega, pago: metodoPago, observaciones: obs,
        items: carrito.map(c => ({ categoria: c.cat, nombre: c.nom, precioBase: c.base, cantidad: c.qty, extrasTexto: c.xTxt, subtotal: c.sub })),
        total: parseFloat(document.getElementById('lbl-total-final').innerText),
        estatus: "Pendiente"
      };

      try {
        // 4. Registrar/Actualizar Cliente
        const email = document.getElementById('cli-email').value.trim();
        if (email) {
          const clientRef = doc(db, "clientes", email.toLowerCase());
          const clientSnap = await getDoc(clientRef);
          const now = new Date().toISOString();

          if (clientSnap.exists()) {
            await setDoc(clientRef, {
              nombre: nom,
              tel: tel,
              ultimoPedido: now
            }, { merge: true });
          } else {
            await setDoc(clientRef, {
              nombre: nom,
              email: email.toLowerCase(),
              tel: tel,
              primerPedido: now,
              ultimoPedido: now
            });
          }
        }

        await addDoc(collection(db, "pedidos"), orden);

        document.getElementById('modal-checkout').classList.add('hidden');
        var msg = "Tu pedido ha sido enviado a cocina.";
        if (metodoPago === 'transferencia') msg += " Realiza tu pago a la cuenta NU.";

        alertUI("¬°Pedido Recibido!", msg, "üë©‚Äçüç≥", function () {
          resetApp();
        });

      } catch (err) {
        console.error(err);
        alertUI("Error", "No se pudo enviar el pedido. Intenta de nuevo.", "‚ùå");
      } finally {
        btn.disabled = false; btn.innerText = txt;
      }
    };

    function loadMaps() {
      var s = document.createElement('script');
      s.src = "https://maps.googleapis.com/maps/api/js?key=AIzaSyDFtHd9yreTJp6f7Ys0-oNdPhl5iDGmmUE&libraries=places&callback=initMaps&loading=async";
      s.async = true; s.defer = true;
      document.head.appendChild(s);
    }
    window.initMaps = function () {
      var i = document.getElementById('cli-dir');
      if (i) {
        new google.maps.places.Autocomplete(i, { componentRestrictions: { country: "mx" }, types: ["address"] });
        i.addEventListener('keydown', e => { if (e.key === 'Enter') e.preventDefault() });
      }
    };
  </script>
</body>

</html>